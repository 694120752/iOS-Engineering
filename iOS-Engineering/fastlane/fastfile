# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#
# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane
default_platform(:ios)
podspecFileName = "DTMSDK.podspec"
fainalFilePath = "DTM"
licenseFile = "LICENSE"
platform :ios do
  desc "è¿™æ˜¯ç”¨æ¥æ‰“åŒ…å¹¶ä¸Šä¼ äº‘é¾™ä»“çš„è„šæœ¬"
  lane :custom_lane do
    # add actions here: https://docs.fastlane.tools/actions
  end
end
  ## Dtmçš„frameworkæ‰“åŒ…
  ## é»˜è®¤æ‰“åŒ…å£ä»¤ ï¼š
  ##      fastlane build_dtm
  desc "åˆå¹¶æ‰“framework å¯é…ç½®ç‰ˆæœ¬å·å’Œæ‰“åŒ…æ¨¡å¼"
  lane :build_dtm do |options|
    debug = options[:debug]
    version = options[:v]
    if version
      # æ›´æ–°podspecä¸­çš„ç‰ˆæœ¬å·
      version_bump_podspec(path: "./#{podspecFileName}", version_number: version)
    else
      # è¯»å–podspecä¸­çš„ç‰ˆæœ¬å·
      spec = read_podspec(path: "./#{podspecFileName}")
      version = spec["version"]
    end
    # æœªé…ç½®buildModeæ—¶ é»˜è®¤ä¸ºRelease
    buildMode = "Release"
    if "debug" == debug
      buildMode = "Debug"
    end
    # å…ˆç¼–è¯‘socketframework
    Dir.chdir("../Pods") do
      sh("xcodebuild","-scheme","SocketRocket","-project","./Pods.xcodeproj","-configuration","#{buildMode}","-sdk","iphoneos","-arch","armv7s","-arch","arm64","-arch","arm64e","-arch","armv7")
      sh("xcodebuild","-scheme","SocketRocket","-project","./Pods.xcodeproj","-configuration","#{buildMode}","-sdk","iphonesimulator","-arch","x86_64")
      sh("cd ..")
    end
    # æ‰§è¡Œæ‰“åŒ…
    sh("fastlane","build_framework","debug:#{buildMode}","v:#{version}","n:DTMSDK")
    sh("fastlane","build_resource","debug:#{buildMode}","v:#{version}","n:DTMResource")
    # åˆå¹¶å‹ç¼©
    zip_file = "./build/#{version}/#{fainalFilePath}/dtmiossdk-maven-#{version}.zip"
    zip(path:"./#{licenseFile}/#{licenseFile}",output_path:zip_file)
    zip(path:"./build/DTMSDK/#{version}/DTMSDK.framework",output_path:zip_file)
    zip(path:"./build/DTMResource/#{version}/DTMResource.bundle",output_path:zip_file)
    zip(path:"./DynamicTagManagerSDK/GRS/GRS_C.framework",output_path:zip_file)
    zip(path:"./DynamicTagManagerSDK/HAFormal/HAFormalAnalytics.framework",output_path:zip_file)
    zip(path:"./DynamicTagManagerSDK/HAFormal/HAFormal.bundle",output_path:zip_file)
    # æ‰§è¡Œç¬¬äºŒæ¬¡æ‰“åŒ…
    sh("fastlane","build_framework","debug:#{buildMode}","v:#{version}","n:DTMSDK-rebuild")
    sh("fastlane","build_resource","debug:#{buildMode}","v:#{version}","n:DTMResource-rebuild")
    # åˆå¹¶å‹ç¼©
    zip_file = "./build/#{version}/#{fainalFilePath}-rebuild/dtmiossdk-maven-#{version}.zip"
    zip(path:"./#{licenseFile}/#{licenseFile}",output_path:zip_file)
    zip(path:"./build/DTMSDK-rebuild/#{version}/DTMSDK.framework",output_path:zip_file)
    zip(path:"./build/DTMResource-rebuild/#{version}/DTMResource.bundle",output_path:zip_file)
    zip(path:"./DynamicTagManagerSDK/GRS/GRS_C.framework",output_path:zip_file)
    zip(path:"./DynamicTagManagerSDK/HAFormal/HAFormalAnalytics.framework",output_path:zip_file)
    zip(path:"./DynamicTagManagerSDK/HAFormal/HAFormal.bundle",output_path:zip_file)
    
  end
  ## æ‰“åŒ…èµ„æºæ–‡ä»¶
  desc "build resource"
  lane :build_resource do |options|
    fileName = options[:n]
    schemeName = "DTMResource"
    debug = options[:debug]
    version = options[:v]
    all = [fileName]
    buildMode = "Release"
    if "debug" == debug
      buildMode = "Debug"
    end
    all.each do |name|
      # build
      Dir.chdir("..") do
        #compile framework
        sh("xcodebuild", "-target", "./#{name}",
          "-scheme","#{schemeName}",
          "-configuration",buildMode,
          "-sdk","iphoneos",
          "CONFIGURATION_BUILD_DIR=./build/#{fileName}/#{version}")
      end
    end
  end
  ## æ‰“åŒ…DTMFramework
  desc "build DTMFramework framework for module"
  lane :build_framework do |options|
    # é…ç½®å˜é‡
    filename = options[:n]
    targetName = "DTMSDK"
    debug = options[:debug]
    version = options[:v]
    all = [filename]
    buildMode = "Release"
    if "debug" == debug
      buildMode = "Debug"
    end
    all.each do |name|
      # build
      Dir.chdir("..") do
        # CPU æ¶æ„è¯´æ˜
        # armv7ï¼šiPhone4ï½œiPhone4Sï½œiPadï½œiPad2ï½œiPad3(The New iPad)ï½œiPad miniï½œiPod Touch 3Gï½œiPod Touch4
        # armv7sï¼šiPhone5ï½œiPhone5Cï½œiPad4(iPad with Retina Display)
        # arm64ï¼šiPhone 5S / iPhone 6 , iPhone 6 Plus / iPhone 6S , 6S Plus / iPhone 7 , 7 Plus, iPad (2018) /  iPhone 8, iPhone 8 Plus, and iPhone X
        # arm64e: iphone XSã€ iphone XS Maxã€ iphoneXR ++
        # i386é€‰æ‹©iPhone5ä»¥ä¸‹çš„æ¨¡æ‹Ÿå™¨ç¼–è¯‘å³å¯
        # x86_64é€‰æ‹©iPhone5sä»¥ä¸Šçš„æ¨¡æ‹Ÿå™¨ç¼–è¯‘å³å¯
        
        sh("xcodebuild", "-project", "./DynamicTagManagerSDK.xcodeproj",
          "-target","#{targetName}",
          "-configuration",buildMode,
          "-sdk","iphoneos",
          "-arch","armv7s",
          "-arch","arm64",
          "-arch","arm64e",
          "CONFIGURATION_BUILD_DIR=./build/#{filename}/#{version}")
          
        sh("xcodebuild", "-project", "./DynamicTagManagerSDK.xcodeproj",
          "-target","#{targetName}",
          "-configuration",buildMode,
          "-sdk","iphonesimulator",
          "-arch","x86_64",
          "CONFIGURATION_BUILD_DIR=./build/#{filename}/#{version}-simulator")
        sh("lipo","-create",
        "./build/#{filename}/#{version}/#{targetName}.framework/#{targetName}",
        "./build/#{filename}/#{version}-simulator/#{targetName}.framework/#{targetName}",
        "-output",
        "./build/#{filename}/#{version}/#{targetName}.framework/#{targetName}")
        
        sh("rm", "./build/#{filename}/#{version}/#{targetName}.framework/Info.plist")
        
      end    
    end
  end
      
  # ä¸Šä¼ dtm åˆå¹¶ç‰ˆ
  desc "deploy dtm"
  lane :deploy_dtm do |options|
    all = ["dtmframework","dtmframework-rebuild"]
  
    all.each do |name|
      spec = read_podspec(path:"./DTMSDK.podspec")
      version = spec["version"]
      filepath = "DTM"
      if "dtmframework-rebuild" == name
        filepath = "DTM-rebuild"
      end
      zip_path = "./build/#{version}/#{filepath}/dtmiossdk-maven-#{version}.zip"
      artifactory(file:zip_path,
        username: "cloudreleaserepo",
        password: "cloudreleaserepo~!@",
        endpoint:"http://szg1.artifactory.inhuawei.com/artifactory/",
        repo:"Product-CloudReleaseRepo-release",
        #ä¸Šä¼ æ­£å¼æµæ°´çº¿
        repo_path:"com/huawei/cloudreleaserepo/dtmiossdk/#{name}/dtmiossdk-maven-#{version}.zip")
        #ä¸Šä¼ æµ‹è¯•æµæ°´çº¿
        #repo_path:"com/huawei/cloudreleaserepo/dtmiossdk/dtmiossdkapi/dtmiossdk-maven-#{version}.zip")
    end
  end
  # ä¸Šä¼ åˆ°äº‘é¾™ä»“çš„åŒ…éœ€è¦æ›´æ”¹ç‰ˆæœ¬å·
  desc "è®¾ç½®ç‰ˆæœ¬å· è‡ªå¢æœ€åä¸€ä½ æ›´æ–°podspec"
  lane :updateVersion do |options|
    all = ["DynamicTagManagerSDK"]
    version1 = options[:v]
    all.each do |name|
      spec = read_podspec(path: "./#{name}.podspec")
      version = spec["version"]
      versionArr = version.split(".")
      lastNum = versionArr.last.to_i + 1
      versionArr[3] = lastNum.to_s
      version_bump_podspec(version_number: versionArr.join('.'))
      UI.message "ğŸ”¥ğŸ”¥ğŸ”¥   å½“å‰ç‰ˆæœ¬è‡ªå¢ä¸º #{versionArr.join('.')}  ğŸ”¥ğŸ”¥ğŸ”¥"
    end
  end